<?xml version="1.0" encoding="utf-8"?>
<!--
    ================================================================
    PLANTILLAS DEL PORTAL WEB - VISTA MODERNA ESTILO SALES
    ================================================================

    DISEÑO:
    - Layout responsive Bootstrap 5: col-12 col-lg-8 (contenido) + col-12 col-lg-4 (sidebar)
    - Sidebar sticky en desktop con Total y CTAs (Firmar/Rechazar)
    - Contenido principal: Encabezado, Origen/Destino (cards), Tabla de líneas, Resumen

    SEGURIDAD SAAS:
    - El controlador valida waybill.company_id == request.env.company
    - Si no coincide, lanza NotFound (404)
-->
<odoo>
    <!--
        ================================================================
        PLANTILLA PRINCIPAL: DETALLE DE COTIZACIÓN EN EL PORTAL (MODERNO)
        ================================================================
    -->
    <template id="portal_my_waybill" name="My Waybill">
        <t t-name="tms.portal_my_waybill">
            <!--
                t-call: Usa el layout base del portal de Odoo (header, footer, breadcrumbs)
                El contenido se inserta automáticamente en el área principal
            -->
            <t t-call="portal.portal_layout">
                <!--
                    Contenedor principal con padding
                    class="container": Bootstrap container responsive
                -->
                <div class="container mt-4">
                    <!--
                        ================================================================
                        FILA PRINCIPAL: CONTENIDO + SIDEBAR
                        ================================================================
                    -->
                    <div class="row">
                        <!--
                            ================================================================
                            COLUMNA IZQUIERDA: CONTENIDO PRINCIPAL (8 columnas en desktop, 12 en mobile)
                            ================================================================
                        -->
                        <div class="col-12 col-lg-8">
                            <!--
                                ENCABEZADO: Título y fecha
                            -->
                            <div class="mb-4">
                                <h2 class="mb-2">Cotización <span t-esc="waybill.name"/></h2>
                                <p class="text-muted mb-3">
                                    <i class="fa fa-calendar"/> Fecha: <span t-esc="waybill.date_created"/>
                                </p>

                                <!--
                                    Badge de estado: muestra el estado actual con colores
                                -->
                                <div class="mb-3">
                                    <t t-if="waybill.state == 'draft'">
                                        <span class="badge bg-secondary">Solicitud</span>
                                    </t>
                                    <t t-elif="waybill.state == 'en_pedido'">
                                        <span class="badge bg-success">Aceptado</span>
                                    </t>
                                    <t t-elif="waybill.state == 'rejected'">
                                        <span class="badge bg-danger">Rechazado</span>
                                    </t>
                                    <t t-else="">
                                        <span class="badge bg-info" t-esc="waybill.state"/>
                                    </t>
                                </div>

                                <!--
                                    Mensajes de éxito/error desde query string
                                -->
                                <t t-if="request and request.params and request.params.get('success') == 'true'">
                                    <div class="alert alert-success alert-dismissible" role="alert">
                                        <strong>✓ Cotización aceptada correctamente.</strong>
                                        <button type="button" class="btn-close" data-bs-dismiss="alert"/>
                                    </div>
                                </t>
                                <t t-if="request and request.params and request.params.get('rejected') == 'true'">
                                    <div class="alert alert-info alert-dismissible" role="alert">
                                        <strong>Cotización rechazada correctamente.</strong>
                                        <button type="button" class="btn-close" data-bs-dismiss="alert"/>
                                    </div>
                                </t>
                                <t t-if="request and request.params and request.params.get('error')">
                                    <div class="alert alert-danger alert-dismissible" role="alert">
                                        <strong>Error:</strong> <span t-esc="request.params.get('error')"/>
                                        <button type="button" class="btn-close" data-bs-dismiss="alert"/>
                                    </div>
                                </t>
                            </div>

                            <!--
                                ================================================================
                                SECCIÓN: ORIGEN Y DESTINO (CARDS)
                                ================================================================
                            -->
                            <div class="row mb-4">
                                <!-- Card Origen -->
                                <div class="col-md-6 mb-3">
                                    <div class="card h-100">
                                        <div class="card-header bg-primary text-white">
                                            <h5 class="mb-0"><i class="fa fa-map-marker"/> Origen</h5>
                                        </div>
                                        <div class="card-body">
                                            <t t-if="waybill.partner_origin_id">
                                                <p class="mb-2">
                                                    <strong>Cliente:</strong><br/>
                                                    <span t-esc="waybill.partner_origin_id.name"/>
                                                </p>
                                            </t>
                                            <t t-if="waybill.origin_city_id">
                                                <p class="mb-2">
                                                    <strong>Ciudad:</strong><br/>
                                                    <span t-esc="waybill.origin_city_id.name"/>
                                                </p>
                                            </t>
                                            <t t-if="waybill.origin_state_id">
                                                <p class="mb-2">
                                                    <strong>Estado:</strong><br/>
                                                    <span t-esc="waybill.origin_state_id.name"/>
                                                </p>
                                            </t>
                                            <t t-if="waybill.origin_address">
                                                <p class="mb-0">
                                                    <strong>Dirección:</strong><br/>
                                                    <span t-esc="waybill.origin_address"/>
                                                    <t t-if="waybill.origin_zip">, <span t-esc="waybill.origin_zip"/></t>
                                                </p>
                                            </t>
                                        </div>
                                    </div>
                                </div>

                                <!-- Card Destino -->
                                <div class="col-md-6 mb-3">
                                    <div class="card h-100">
                                        <div class="card-header bg-success text-white">
                                            <h5 class="mb-0"><i class="fa fa-flag-checkered"/> Destino</h5>
                                        </div>
                                        <div class="card-body">
                                            <t t-if="waybill.partner_dest_id">
                                                <p class="mb-2">
                                                    <strong>Cliente:</strong><br/>
                                                    <span t-esc="waybill.partner_dest_id.name"/>
                                                </p>
                                            </t>
                                            <t t-if="waybill.dest_city_id">
                                                <p class="mb-2">
                                                    <strong>Ciudad:</strong><br/>
                                                    <span t-esc="waybill.dest_city_id.name"/>
                                                </p>
                                            </t>
                                            <t t-if="waybill.dest_state_id">
                                                <p class="mb-2">
                                                    <strong>Estado:</strong><br/>
                                                    <span t-esc="waybill.dest_state_id.name"/>
                                                </p>
                                            </t>
                                            <t t-if="waybill.dest_address">
                                                <p class="mb-0">
                                                    <strong>Dirección:</strong><br/>
                                                    <span t-esc="waybill.dest_address"/>
                                                    <t t-if="waybill.dest_zip">, <span t-esc="waybill.dest_zip"/></t>
                                                </p>
                                            </t>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!--
                                ================================================================
                                SECCIÓN: TABLA DE LÍNEAS (MERCADERÍAS) - ESTILO SALES
                                ================================================================
                            -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fa fa-cubes"/> Mercancías</h5>
                                </div>
                                <div class="card-body">
                                    <t t-if="waybill.line_ids">
                                        <div class="table-responsive">
                                            <table class="table table-hover">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>Descripción</th>
                                                        <th class="text-end">Cantidad</th>
                                                        <th>Unidad</th>
                                                        <th class="text-end">Peso (Kg)</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <t t-foreach="waybill.line_ids" t-as="line">
                                                        <tr>
                                                            <td>
                                                                <strong t-esc="line.description or ''"/>
                                                                <t t-if="line.product_sat_id">
                                                                    <br/><small class="text-muted" t-esc="line.product_sat_id.name or ''"/>
                                                                </t>
                                                            </td>
                                                            <td class="text-end" t-esc="line.quantity or 0"/>
                                                            <td>
                                                                <t t-if="line.uom_sat_id">
                                                                    <span t-esc="line.uom_sat_id.name or ''"/>
                                                                </t>
                                                                <t t-else="">
                                                                    <span class="text-muted">—</span>
                                                                </t>
                                                            </td>
                                                            <td class="text-end" t-esc="line.weight_kg or 0"/>
                                                        </tr>
                                                    </t>
                                                </tbody>
                                            </table>
                                        </div>
                                    </t>
                                    <t t-else="">
                                        <p class="text-muted mb-0">No hay mercancías registradas.</p>
                                    </t>
                                </div>
                            </div>

                            <!--
                                ================================================================
                                SECCIÓN: RESUMEN (DISTANCIA, DURACIÓN, NOTAS)
                                ================================================================
                            -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fa fa-info-circle"/> Información del Viaje</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <t t-if="waybill.distance_km">
                                            <div class="col-md-4 mb-3">
                                                <strong>Distancia:</strong><br/>
                                                <span t-esc="waybill.distance_km"/> km
                                            </div>
                                        </t>
                                        <t t-if="waybill.duration_hours">
                                            <div class="col-md-4 mb-3">
                                                <strong>Duración Estimada:</strong><br/>
                                                <span t-esc="waybill.duration_hours"/> horas
                                            </div>
                                        </t>
                                        <t t-if="waybill.route_name">
                                            <div class="col-md-4 mb-3">
                                                <strong>Ruta:</strong><br/>
                                                <span t-esc="waybill.route_name"/>
                                            </div>
                                        </t>
                                    </div>
                                </div>
                            </div>

                            <!--
                                ================================================================
                                SECCIÓN: FIRMA EXISTENTE (Si ya fue firmada)
                                ================================================================
                            -->
                            <t t-if="waybill.signature and waybill.state == 'en_pedido'">
                                <div class="card mb-4">
                                    <div class="card-header bg-success text-white">
                                        <h5 class="mb-0"><i class="fa fa-check-circle"/> Cotización Aceptada</h5>
                                    </div>
                                    <div class="card-body">
                                        <t t-if="waybill.signature">
                                            <div class="mb-3">
                                                <strong>Firma Digital:</strong><br/>
                                                <img t-attf-src="data:image/png;base64,{{ waybill.signature }}"
                                                     alt="Firma Digital"
                                                     class="img-fluid border"
                                                     style="max-width: 300px; background: white;"/>
                                            </div>
                                        </t>
                                        <t t-if="waybill.signed_by">
                                            <p class="mb-1"><strong>Firmado por:</strong> <span t-esc="waybill.signed_by"/></p>
                                        </t>
                                        <t t-if="waybill.signed_on">
                                            <p class="mb-0"><strong>Fecha y hora:</strong> <span t-esc="waybill.signed_on"/></p>
                                        </t>
                                    </div>
                                </div>
                            </t>

                            <!--
                                ================================================================
                                SECCIÓN: RECHAZO (Si fue rechazada)
                                ================================================================
                            -->
                            <t t-if="waybill.state == 'rejected' and waybill.rejection_reason">
                                <div class="card mb-4">
                                    <div class="card-header bg-danger text-white">
                                        <h5 class="mb-0"><i class="fa fa-times-circle"/> Cotización Rechazada</h5>
                                    </div>
                                    <div class="card-body">
                                        <p class="mb-0"><strong>Motivo del rechazo:</strong></p>
                                        <p class="text-muted" t-esc="waybill.rejection_reason"/>
                                    </div>
                                </div>
                            </t>
                        </div>

                        <!--
                            ================================================================
                            COLUMNA DERECHA: SIDEBAR (4 columnas en desktop, 12 en mobile)
                            Sidebar sticky en desktop con Total y CTAs
                            ================================================================
                        -->
                        <div class="col-12 col-lg-4">
                            <div class="sticky-top" style="top: 20px;">
                                <!--
                                    Card del Sidebar: Total y Botones de Acción
                                -->
                                <div class="card shadow-sm">
                                    <div class="card-header bg-light">
                                        <h5 class="mb-0"><i class="fa fa-money"/> Total</h5>
                                    </div>
                                    <div class="card-body">
                                        <!--
                                            Total grande con moneda
                                        -->
                                        <div class="mb-4">
                                            <h3 class="mb-0">
                                                <span t-esc="waybill.currency_id.symbol or waybill.currency_id.name or ''"/>
                                                <span t-esc="waybill.amount_total or 0"/>
                                            </h3>
                                            <small class="text-muted">Monto Total</small>
                                        </div>

                                        <!--
                                            Botones de Acción (CTAs)
                                            Solo se muestran si el estado permite firma/rechazo
                                        -->
                                        <t t-if="waybill.state in ('draft', 'en_pedido') and not waybill.signature">
                                            <!--
                                                Botón Principal: Firmar y Aceptar
                                            -->
                                            <button type="button"
                                                    class="btn btn-primary w-100 mb-2"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#signModal">
                                                <i class="fa fa-pencil"/> Firmar y Aceptar
                                            </button>

                                            <!--
                                                Botón Secundario: Rechazar
                                            -->
                                            <button type="button"
                                                    class="btn btn-outline-danger w-100 mb-2"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#rejectModal">
                                                <i class="fa fa-times"/> Rechazar
                                            </button>
                                        </t>

                                        <!--
                                            Botón: Descargar PDF
                                        -->
                                        <a t-attf-href="/my/waybills/{{ waybill.id }}/pdf?access_token={{ token }}&amp;download=1"
                                           class="btn btn-outline-secondary w-100"
                                           target="_blank">
                                            <i class="fa fa-download"/> Descargar PDF
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!--
                    ================================================================
                    MODAL: FIRMA DIGITAL
                    ================================================================
                -->
                <div class="modal fade" id="signModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Firmar y Aceptar Cotización</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"/>
                            </div>
                            <form t-attf-action="/my/waybills/{{ waybill.id }}/sign" method="post">
                                <t t-if="token">
                                    <input type="hidden" name="access_token" t-att-value="token"/>
                                </t>
                                <div class="modal-body">
                                    <!--
                                        Campo de nombre del firmante (#signature_name)
                                    -->
                                    <div class="mb-3">
                                        <label for="signature_name" class="form-label">Nombre Completo *</label>
                                        <input type="text"
                                               class="form-control"
                                               id="signature_name"
                                               name="name"
                                               required="required"
                                               placeholder="Ingrese su nombre completo"/>
                                    </div>

                                    <!--
                                        Opción: Método de firma (Radio buttons)
                                    -->
                                    <div class="mb-3">
                                        <label class="form-label">Método de Firma</label>
                                        <div class="form-check">
                                            <input class="form-check-input"
                                                   type="radio"
                                                   name="signMethod"
                                                   id="signMethodManual"
                                                   value="manual"
                                                   checked="checked"/>
                                            <label class="form-check-label" for="signMethodManual">
                                                Firmar a mano
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input"
                                                   type="radio"
                                                   name="signMethod"
                                                   id="signMethodGenerated"
                                                   value="generated"/>
                                            <label class="form-check-label" for="signMethodGenerated">
                                                Generar firma con mi nombre
                                            </label>
                                        </div>
                                    </div>

                                    <!--
                                        Canvas para capturar firma (#signatureCanvas)
                                        CRÍTICO: El tamaño visual se establece con CSS (width: 100%, height: 220px)
                                        El tamaño interno (resolución) se ajusta automáticamente en JS según devicePixelRatio
                                    -->
                                    <div class="mb-3">
                                        <label class="form-label">Firma Digital *</label>
                                        <!--
                                            Contenedor del canvas con posición relativa para evitar interferencias
                                            overflow: hidden previene scroll dentro del contenedor
                                        -->
                                        <div class="border rounded p-2 bg-white" style="position: relative; overflow: hidden;">
                                            <canvas id="signatureCanvas"
                                                    style="width: 100%; height: 220px; display: block;"/>
                                        </div>
                                        <small class="text-muted">
                                            <span id="signatureHint">Dibuje su firma en el recuadro superior</span>
                                        </small>
                                        <!--
                                            Input oculto para almacenar la firma en base64 (#signature_data)
                                            Se llena automáticamente cuando se envía el formulario
                                        -->
                                        <input type="hidden" name="signature" id="signature_data"/>
                                    </div>

                                    <!--
                                        Botones de acción: Limpiar y Generar Firma
                                    -->
                                    <div class="mb-3">
                                        <!--
                                            Botón "Limpiar Firma" (#clearSignature)
                                            type="button" para evitar submit accidental
                                        -->
                                        <button type="button"
                                                class="btn btn-sm btn-outline-secondary me-2"
                                                id="clearSignature">
                                            <i class="fa fa-eraser"/> Limpiar Firma
                                        </button>
                                        <!--
                                            Botón "Generar Firma" (#generateSignatureBtn)
                                            Solo visible cuando se selecciona "Generar firma con mi nombre"
                                            type="button" para evitar submit accidental
                                        -->
                                        <button type="button"
                                                class="btn btn-sm btn-outline-primary"
                                                id="generateSignatureBtn"
                                                style="display: none;">
                                            <i class="fa fa-font"/> Generar Firma
                                        </button>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                    <button type="submit" class="btn btn-primary" id="confirmSignBtn">
                                        <i class="fa fa-check"/> Confirmar Firma
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!--
                    ================================================================
                    MODAL: RECHAZO
                    ================================================================
                -->
                <div class="modal fade" id="rejectModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-danger text-white">
                                <h5 class="modal-title">Rechazar Cotización</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"/>
                            </div>
                            <form t-attf-action="/my/waybills/{{ waybill.id }}/reject" method="post">
                                <t t-if="token">
                                    <input type="hidden" name="access_token" t-att-value="token"/>
                                </t>
                                <div class="modal-body">
                                    <div class="alert alert-warning">
                                        <strong>¿Está seguro que desea rechazar esta cotización?</strong><br/>
                                        Por favor, indique el motivo del rechazo.
                                    </div>
                                    <div class="mb-3">
                                        <label for="rejection_reason" class="form-label">Motivo del Rechazo *</label>
                                        <textarea class="form-control"
                                                  id="rejection_reason"
                                                  name="rejection_reason"
                                                  rows="4"
                                                  required="required"
                                                  placeholder="Describa el motivo por el cual rechaza esta cotización..."/>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                    <button type="submit" class="btn btn-danger">
                                        <i class="fa fa-times"/> Confirmar Rechazo
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </t>
        </t>
    </template>
</odoo>
