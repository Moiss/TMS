<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!--
        ================================================================
        EXTENSIÓN DE VISTAS DE FLEET.VEHICLE
        ================================================================

        VENTAJAS DE HEREDAR EL MÓDULO NATIVO:
        - Aprovechamos TODAS las vistas existentes de Fleet
        - No duplicamos código
        - Los usuarios ven la interfaz familiar de Odoo
        - Mantenimiento, costos, contratos ya funcionan automáticamente

        ESTRATEGIA:
        - Heredamos la vista form de fleet
        - Agregamos nuestros campos en una pestaña nueva
        - Usamos invisible para ocultar campos según tipo (tractor/remolque)
    -->

    <!--
        ================================================================
        EXTENSIÓN DE FORM VIEW - Agregar pestaña "Configuración TMS"
        ================================================================
    -->
    <record id="view_fleet_vehicle_form_tms" model="ir.ui.view">
        <field name="name">fleet.vehicle.form.tms</field>
        <field name="model">fleet.vehicle</field>
        <!-- inherit_id: Vista que estamos extendiendo (la vista form nativa de fleet) -->
        <field name="inherit_id" ref="fleet.fleet_vehicle_view_form"/>
        <field name="arch" type="xml">

            <!--
                Insertar campo is_trailer al inicio del formulario
                Lo colocamos después del campo 'active' usando xpath
            -->
            <xpath expr="//field[@name='active']" position="after">
                <!--
                    Campo checkbox: Es Remolque
                    Este campo cambia la lógica del formulario completo
                -->
                <field name="is_trailer" widget="boolean_toggle"/>
            </xpath>

            <!--
                Agregar pestaña "Configuración TMS" dentro del notebook
                xpath: busca el elemento <notebook> y agrega dentro (inside)
            -->
            <xpath expr="//notebook" position="inside">
                <!--
                    Nueva pestaña: Configuración TMS
                    Contiene todos los campos específicos para transporte
                -->
                <page string="Configuración TMS" name="page_tms_config">

                    <!-- Sección: Identificación -->
                    <group string="Identificación">
                        <field name="no_economico"/>
                    </group>

                    <!-- Sección: Configuración SAT -->
                    <group string="Configuración SAT (Carta Porte 3.1)">
                        <group>
                            <!-- Configuración vehicular SAT -->
                            <field name="sat_config_id"/>

                            <!--
                                Campos específicos para REMOLQUES
                                invisible: solo visible si is_trailer es True
                            -->
                            <field name="sat_subtype_id"
                                   invisible="is_trailer == False"/>
                        </group>

                        <group>
                            <!--
                                Campos específicos para TRACTORES
                                invisible: solo visible si is_trailer es False
                            -->
                            <field name="sat_permiso_sct_id"
                                   invisible="is_trailer == True"/>

                            <field name="permiso_sct_number"
                                   invisible="is_trailer == True"/>
                        </group>
                    </group>

                    <!-- Sección: Seguros (para Carta Porte) -->
                    <group string="Seguro (Carta Porte)">
                        <group>
                            <field name="insurance_company"/>
                        </group>
                        <group>
                            <field name="insurance_policy"/>
                        </group>
                    </group>

                    <!--
                        Sección: Remolques Asignados
                        Solo visible para TRACTORES (is_trailer=False)
                    -->
                    <group string="Remolques Asignados"
                           invisible="is_trailer == True">
                        <group>
                            <!-- Many2one: Remolque 1 -->
                            <!-- Domain asegura que solo muestre remolques de la misma empresa -->
                            <field name="trailer1_id"/>
                        </group>
                        <group>
                            <!-- Many2one: Remolque 2 -->
                            <field name="trailer2_id"/>
                        </group>
                    </group>

                    <!--
                        Sección: Rendimiento
                        Solo para TRACTORES (tienen motor)
                    -->
                    <group string="Rendimiento"
                           invisible="is_trailer == True">
                        <field name="performance_km_l"/>
                    </group>

                </page>
            </xpath>

        </field>
    </record>

    <!--
        ================================================================
        ACCIÓN: VEHÍCULOS (Solo Tractores)
        ================================================================
    -->
    <record id="action_tms_vehicles" model="ir.actions.act_window">
        <field name="name">Vehículos (Tractores)</field>
        <field name="res_model">fleet.vehicle</field>
        <field name="view_mode">list,form</field>
        <!--
            Domain: Solo muestra vehículos que NO son remolques
            Esto filtra automáticamente para mostrar solo tractocamiones
        -->
        <field name="domain">[('is_trailer', '=', False)]</field>
        <!--
            Context: Al crear un nuevo registro, is_trailer será False por defecto
        -->
        <field name="context">{'default_is_trailer': False}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Agregar un vehículo
            </p>
            <p>
                Registra tractocamiones y camiones unitarios.
            </p>
        </field>
    </record>

    <!--
        ================================================================
        ACCIÓN: REMOLQUES
        ================================================================
    -->
    <record id="action_tms_trailers" model="ir.actions.act_window">
        <field name="name">Remolques</field>
        <field name="res_model">fleet.vehicle</field>
        <field name="view_mode">list,form</field>
        <!--
            Domain: Solo muestra vehículos que SÍ son remolques
        -->
        <field name="domain">[('is_trailer', '=', True)]</field>
        <!--
            Context: Al crear, is_trailer será True por defecto
        -->
        <field name="context">{'default_is_trailer': True}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Agregar un remolque
            </p>
            <p>
                Registra remolques y semirremolques.
            </p>
        </field>
    </record>

</odoo>

