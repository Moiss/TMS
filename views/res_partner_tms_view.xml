<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <record id="view_partner_form_tms_sat_address" model="ir.ui.view">
        <field name="name">res.partner.form.tms.address</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.view_partner_form"/>
        <field name="arch" type="xml">

            <!-- 1. CAMPO AUXILIAR (Invisible pero necesario para dominios) -->
            <xpath expr="//sheet" position="before">
                <field name="tms_sat_state_code" invisible="1"/>
            </xpath>

            <!-- 2. REEMPLAZO DE ZIP (Código Postal) -->
            <!-- Usamos xpath genérico para encontrar el zip dentro del bloque de dirección -->
            <xpath expr="//div[hasclass('o_address_format')]//field[@name='zip']" position="replace">
                <!-- Campo SAT Seleccionable -->
                <field name="tms_cp_id"
                       placeholder="Código Postal"
                       class="o_address_zip"
                       options="{'no_create': True, 'no_open': True}"/>
                <!-- Campo Nativo Oculto (para compatibilidad) -->
                <field name="zip" invisible="1"/>
            </xpath>

            <!-- 3. INYECCIÓN DE CAMPOS GEOGRÁFICOS SAT -->
            <!-- Insertamos justo después del Estado (state_id) dentro del bloque de dirección -->
            <xpath expr="//div[hasclass('o_address_format')]//field[@name='state_id']" position="after">

                <!-- Municipio y Localidad en una línea -->
                <div class="d-flex w-100 gap-1">
                    <field name="l10n_mx_edi_municipio_sat_id"
                           placeholder="Municipio"
                           class="o_address_city"
                           options="{'no_create': True, 'no_open': True}"
                           domain="[('estado', '=', tms_sat_state_code)]"/>

                    <field name="l10n_mx_edi_localidad_sat_id"
                           placeholder="Localidad"
                           class="o_address_city"
                           options="{'no_create': True, 'no_open': True}"
                           domain="[('estado', '=', tms_sat_state_code)]"/>
                </div>

                <!-- Colonia en su propia línea -->
                <div class="w-100">
                    <field name="l10n_mx_edi_colonia_sat_id"
                           placeholder="Colonia"
                           class="o_address_street"
                           options="{'no_create': True, 'no_open': True}"
                           domain="[('zip_code', '=', zip)]"/>
                </div>

            </xpath>

            <!-- 4. SEGURIDAD SAAS: Company ID (Protegido) -->
            <xpath expr="//div[hasclass('o_address_format')]" position="after">
                <field name="company_id" groups="base.group_multi_company" invisible="1"/>
            </xpath>

        </field>
    </record>
</odoo>
