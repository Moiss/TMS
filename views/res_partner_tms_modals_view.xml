<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- 1. MODAL DE DIRECCIONES (Standalone Address Form) -->
    <!-- Usado cuando se abre una dirección desde otros contextos o wizard -->
    <record id="view_partner_address_form_tms_sat" model="ir.ui.view">
        <field name="name">res.partner.address.form.tms.sat</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.view_partner_address_form"/>
        <field name="arch" type="xml">

            <!-- Campo Auxiliar para dominios (Invisible) -->
            <xpath expr="//field[@name='type']" position="before">
                <field name="tms_sat_state_code" invisible="1"/>
            </xpath>

            <!-- Reemplazo de ZIP con campo tms_cp_id -->
            <xpath expr="//div[hasclass('o_address_format')]//field[@name='zip']" position="replace">
                <field name="tms_cp_id"
                       placeholder="Código Postal"
                       class="o_address_zip"
                       options="{'no_create': True, 'no_open': True}"/>
                <field name="zip" invisible="1"/>
            </xpath>

            <!-- Inserción de Campos SAT: Municipio, Localidad, Colonia -->
            <xpath expr="//div[hasclass('o_address_format')]//field[@name='state_id']" position="after">
                <!-- Municipio y Localidad -->
                <div class="d-flex w-100 gap-1">
                    <field name="l10n_mx_edi_municipio_sat_id"
                           placeholder="Municipio"
                           class="o_address_city"
                           options="{'no_create': True, 'no_open': True}"
                           domain="[('estado', '=', tms_sat_state_code)]"/>

                    <field name="l10n_mx_edi_localidad_sat_id"
                           placeholder="Localidad"
                           class="o_address_city"
                           options="{'no_create': True, 'no_open': True}"
                           domain="[('estado', '=', tms_sat_state_code)]"/>
                </div>
                <!-- Colonia -->
                <div class="w-100">
                    <field name="l10n_mx_edi_colonia_sat_id"
                           placeholder="Colonia"
                           class="o_address_street"
                           options="{'no_create': True, 'no_open': True}"
                           domain="[('zip_code', '=', zip)]"/>
                </div>
            </xpath>

        </field>
    </record>

    <!-- 2. MODAL DE CONTACTO HIJO (Dentro del Formulario Principal) -->
    <!-- Se accede a través del campo child_ids en base.view_partner_form -->
    <record id="view_partner_form_child_modal_tms_sat" model="ir.ui.view">
        <field name="name">res.partner.form.child.modal.tms.sat</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.view_partner_form"/>
        <field name="arch" type="xml">

            <!-- Apuntamos específicamente al FORMULARIO embebido dentro de child_ids -->

            <!-- Campo Auxiliar en el modal hijo -->
            <xpath expr="//field[@name='child_ids']//form//field[@name='type']" position="before">
                <field name="tms_sat_state_code" invisible="1"/>
            </xpath>

            <!-- Reemplazo de ZIP en el modal hijo -->
            <xpath expr="//field[@name='child_ids']//form//div[hasclass('o_address_format')]//field[@name='zip']" position="replace">
                <field name="tms_cp_id"
                       placeholder="Código Postal"
                       class="o_address_zip"
                       options="{'no_create': True, 'no_open': True}"/>
                <field name="zip" invisible="1"/>
            </xpath>

            <!-- Inserción de Campos SAT en el modal hijo -->
            <xpath expr="//field[@name='child_ids']//form//div[hasclass('o_address_format')]//field[@name='state_id']" position="after">
                <div class="d-flex w-100 gap-1">
                    <field name="l10n_mx_edi_municipio_sat_id"
                           placeholder="Municipio"
                           class="o_address_city"
                           options="{'no_create': True, 'no_open': True}"
                           domain="[('estado', '=', tms_sat_state_code)]"/>

                    <field name="l10n_mx_edi_localidad_sat_id"
                           placeholder="Localidad"
                           class="o_address_city"
                           options="{'no_create': True, 'no_open': True}"
                           domain="[('estado', '=', tms_sat_state_code)]"/>
                </div>
                <div class="w-100">
                    <field name="l10n_mx_edi_colonia_sat_id"
                           placeholder="Colonia"
                           class="o_address_street"
                           options="{'no_create': True, 'no_open': True}"
                           domain="[('zip_code', '=', zip)]"/>
                </div>
            </xpath>

        </field>
    </record>

</odoo>
